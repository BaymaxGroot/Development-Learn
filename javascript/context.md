# 执行上下文、执行栈

    每次Javascript运行都是在执行上下文中运行

## 执行上下文

    当前JS代码被解析和执行时所处的环境的抽象
 
### 执行上下文 - 分类

1. 全局执行上下文

    默认/基础上下文，任何不在函数内部的代码都在全局上下文中；创建window对象(浏览器)，并设置this=window
    (一个程序只能有一个全局执行上下文)

2. 函数执行上下文

    当函数调用时，会为该函数创建一个新的执行上下文
    每个函数都有自己的执行上下文

3. eval函数执行上下文

    执行eval函数内部的代码也会有它自己的执行上下文

### 执行上下文 - 创建阶段

1. this绑定

    请参考 [this.md](./this.md)

2. 创建词法环境

    词法环境有两个组件: 环境记录器和一个外部环境的引用

    词法环境有以下两种类型
    
        1. 全局环境
            外部环境引用为null
            它拥有内建的Object、Array等
            在环境记录器内的原型函数(关联全局对象 window)，还有任何用户定义的全局变量，并且this指向全局对象       
        
        2. 函数环境
            函数内部用户定义的变量存储在环境记录器，并且引用的外部环境可能是全局环境或任何包含此内部函数的外部函数

    环境记录器也有两种类型

        1. 声明式环境记录器 (函数环境)
            存储变量、函数、参数
            (还包含了一个传递给函数的arguments对象)

        2. 对象环境记录器 (全局环境)
            用来定义出现在全局上下文中的变量和函数的关系

    词法环境被用于获取变量和函数
    这一过程会生成作用域链，确定this指向

3. 创建变量环境

    存储声明的变量和函数
    会创建变量对象，用来存储所有声明的变量和函数
    (变量提升就发生在这个阶段)

### 执行上下文 - 执行阶段

    变量对象变为活动对象，原先声明的变量会被赋值

## 执行栈

    即调用栈，是一种后进先出结构，被用来存储代码运行时创建的所有执行上下文

    在代码开始执行时，首先进入全局环境，此时全局执行上下文被创建并入栈；之后当函数调用时则进入相应的函数环境，此时函数执行上下文被创建并入栈；当处于栈顶的执行上下文所有的代码都执行完毕之后，执行上下文栈就会将该函数执行上下文弹出，将控制权交给之前的执行上下文
    
